# mTCP: A Highly Scalable User-level TCP Stack for Multicore Systems 阅读笔记

在现在的操作系统中，当有大量的短链接时，操作系统并不能充分利用CPU的性能。为了提高scalability，作者提出了mTCP，一个用户态的TCP协议栈。经过实验对比，发现其性能在8核的机器上甚至能达到Linux的25倍。

### 现有的内核中的TCP协议栈的性能问题

* 缺乏locality。 一个packet，有可能网卡将其交给一个核，实际处理的时候却在另外一个核上。这样丧失了locality，会导致性能下降。同时，多个进程有可能都在监听同一个端口，这样就会加剧锁的竞争，使得性能下降。
* 在Linux中，socket是通过fd来进行描述的。而这些操作会通过VFS，比如创建socket的时候，就会找一个最小的没有分配过的fd，而这些会带来很多锁的竞争。
* 目前，操作系统会对每一个包进行单独处理，然而，这回带来很多开销。如果采用batch的方式，能够提升很多性能。
* 每次进行系统调用时，在用户态和内核态之间的切换都会有性能的开销。

### mTCP的设计

* 为每个核维护自己的数据结构。包括tcb，socket的buffer，以及相应的队列。
* 使用轮询的机制，来向NIC来检测有没有自己的数据包。
* 对于所有的事件，使用batch，来平摊各种额外的开销。
* 使用优先队列，优先处理比较重要的包，防止其被其他的包delay。
* 预先分配一个比较大的内存池，来减少内存分配的开销

### mTPC的编程接口 

mTCP使用了和BSD socket所相似的接口，使得应用程序能够在很少的代码修改下就可以使用mTCP。

